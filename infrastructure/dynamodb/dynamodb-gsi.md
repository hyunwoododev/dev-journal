# DynamoDB GSI (Global Secondary Index) 동작 방식 정리

이 문서는 DynamoDB의 GSI가 데이터를 어떻게 관리하는지, 특히 기본 테이블과 GSI 간의 데이터 처리 방식의 차이점을 명확히 설명합니다.

## 핵심 개념

*   **기본 테이블 (Base Table):** 실제 데이터가 저장되는 테이블입니다. PK(Partition Key)와 SK(Sort Key)의 조합으로 각 항목을 고유하게 식별합니다.
*   **GSI (Global Secondary Index):** 기본 테이블의 데이터를 복제하여 생성되는 별도의 인덱스입니다. GSI는 자신만의 GSI PK와 GSI SK를 가지며, 이를 통해 효율적인 쿼리를 지원합니다.

## 기본 테이블과 GSI의 데이터 처리 방식 차이

가장 중요한 차이점은 PK와 SK를 처리하는 방식입니다.

### 1. 기본 테이블

기본 테이블에서는 PK와 SK의 조합이 *완전히 동일한* 항목을 쓰려고 하면, 기존 항목을 *덮어씁니다*. 이는 데이터의 유일성을 보장하기 위한 DynamoDB의 기본 동작 방식입니다.

**예시:**

| PK             | SK        | CreatedAt    | OrderStatusDate     |
| :------------- | :-------- | :----------- | :------------------ |
| USER#hyunwoo   | ORDER#3   | 2023-10-26   | PLACED#2023-10-26   |
| USER#hyunwoo   | ORDER#3   | 2023-10-27   | PLACED#2023-10-26   | (기존 항목 덮어쓰기)

### 2. GSI

GSI는 기본 테이블의 데이터를 *복제*하여 생성되지만, PK와 SK *뿐만 아니라 다른 속성들도 함께 저장*합니다. 따라서, GSI PK와 GSI SK가 동일하더라도, 다른 속성 값들이 다르다면 GSI는 이들을 *서로 다른 항목으로 인식*합니다. 즉, GSI 내부에서는 "GSI PK와 GSI SK의 조합 + 추가 속성들"이 항목의 고유 식별자 역할을 합니다.

**예시:**

| GSI PK         | GSI SK            | Other Attributes (기본 테이블에서 복제) |
| :------------- | :---------------- | :------------------------------------- |
| USER#hyunwoo   | PLACED#2023-10-26 | ORDER#3, 2023-10-26                     |
| USER#hyunwoo   | PLACED#2023-10-26 | ORDER#3, 2023-10-27                     | (새로운 항목 추가)

위의 예시에서 GSI PK와 GSI SK는 동일하지만, `CreatedAt` 속성 값이 다르기 때문에 GSI는 두 항목을 서로 다른 항목으로 저장합니다.

## GSI 내부 동작 방식 상세

GSI는 PK와 SK를 사용하여 해시 값을 생성하고, 이 해시 값을 기반으로 데이터를 저장할 파티션을 결정합니다. 만약 PK와 SK가 동일한 항목이 여러 개 있다면, 해시 값도 동일하게 생성됩니다. 하지만, DynamoDB는 각 항목의 *모든 속성을 함께 저장*하기 때문에, 해시 값이 동일하더라도 *실제 데이터가 다르기 때문에* 두 항목을 *서로 다른 항목으로 구별*할 수 있습니다.

**내부 저장 방식의 예시:**

| Hash Value (PK+SK) | PK             | GSI SK            | Other Attributes (기본 테이블에서 복제) |
| :------------------ | :------------- | :---------------- | :------------------------------------- |
| HASH(USER#hyunwoo, PLACED#2023-10-26) | USER#hyunwoo   | PLACED#2023-10-26 | ORDER#3, 2023-10-26                     |
| HASH(USER#hyunwoo, PLACED#2023-10-26) | USER#hyunwoo   | PLACED#2023-10-26 | ORDER#4, 2023-10-27                     |

## GSI 쿼리 방식

GSI를 사용하여 쿼리하는 경우, GSI의 PK와 SK를 사용하여 데이터를 찾습니다. GSI는 필요한 속성만 복제하여 저장하기 때문에, 기본 테이블의 모든 속성을 가지고 있지는 않습니다. 따라서, GSI에서 필요한 모든 정보를 얻을 수 없는 경우, GSI에서 얻은 정보를 바탕으로 *기본 테이블을 다시 쿼리*하여 나머지 정보를 가져오는 것이 일반적인 패턴입니다.

## 요약

*   기본 테이블: PK와 SK의 조합이 동일하면 기존 항목을 *덮어씁니다*.
*   GSI: GSI PK와 GSI SK가 동일하더라도, 다른 속성 값이 다르다면 *새로운 항목으로 추가*합니다.
*   GSI 내부에서는 "GSI PK와 GSI SK의 조합 + 추가 속성들"이 항목의 고유 식별자 역할을 합니다.
*   GSI 쿼리 시, 필요한 경우 기본 테이블을 추가로 쿼리합니다.

이러한 GSI의 특성을 잘 이해하고 활용하면, 다양한 쿼리 패턴을 효율적으로 지원하는 데이터 모델을 설계할 수 있습니다.
